name: Sync Bedrock Autoloader

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download latest files
        run: |
          curl -sS https://raw.githubusercontent.com/roots/bedrock-autoloader/master/src/Autoloader.php -o Autoloader.php
          curl -sS https://raw.githubusercontent.com/roots/bedrock/master/web/app/mu-plugins/bedrock-autoloader.php -o wrapper.php

      - name: Set version variable
        id: set_version
        run: echo "VERSION=1.0.$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Create combined file
        run: |
          VERSION="${{ steps.set_version.outputs.VERSION }}"
          cat > bedrock-autoloader.php << HEADER
          <?php
          /**
           * Plugin Name:  Bedrock Autoloader MU
           * Plugin URI:   https://github.com/wp-spaghetti/bedrock-autoloader-mu
           * Description:  An autoloader that enables standard plugins to be required just like must-use plugins. The autoloaded plugins are included during mu-plugin loading. An asterisk (*) next to the name of the plugin designates the plugins that have been autoloaded. Self-contained version, auto-synced daily from roots/bedrock.
           * Version:      \${VERSION}
           * Author:       Frugan
           * Author URI:   https://github.com/wp-spaghetti
           * License:      MIT
           * License URI:  https://opensource.org/licenses/MIT
           * 
           * Based on original work by Roots (https://roots.io/)
           * 
           * This file is auto-generated by combining:
           * - https://github.com/roots/bedrock-autoloader/blob/master/src/Autoloader.php
           * - https://github.com/roots/bedrock/blob/master/web/app/mu-plugins/bedrock-autoloader.php
           * 
           * @package wp-spaghetti/bedrock-autoloader-mu
           */

          HEADER
          
          # Extract only the class from Autoloader.php (remove <?php tag)
          sed '1d' Autoloader.php >> bedrock-autoloader.php
          
          # Add spacing
          echo "" >> bedrock-autoloader.php
          echo "" >> bedrock-autoloader.php
          
          # Extract the execution part from wrapper.php (remove header comments and <?php)
          sed -n '/^namespace/,/^}/p' wrapper.php >> bedrock-autoloader.php || \
          sed -n '/if.*is_blog_installed/,$p' wrapper.php >> bedrock-autoloader.php
          
          # Cleanup temporary files
          rm Autoloader.php wrapper.php

      - name: Check for changes
        id: check_changes
        run: |
          # Add file to staging to detect both new and modified files
          git add bedrock-autoloader.php
          if git diff --cached --quiet bedrock-autoloader.php; then
            echo "No changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in bedrock-autoloader.php"
          fi

      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add bedrock-autoloader.php
          git commit -m "chore: sync bedrock-autoloader.php from roots/bedrock"
          git push

      - name: Create new tag if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          VERSION="${{ steps.set_version.outputs.VERSION }}"
          git tag -a "v${VERSION}" -m "Auto-sync version ${VERSION}"
          git push origin "v${VERSION}"