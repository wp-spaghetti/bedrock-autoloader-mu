name: Sync

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download latest files
        run: |
          curl -sS https://raw.githubusercontent.com/roots/bedrock-autoloader/master/src/Autoloader.php -o Autoloader.php
          curl -sS https://raw.githubusercontent.com/roots/bedrock/master/web/app/mu-plugins/bedrock-autoloader.php -o wrapper.php

      - name: Create combined file without version update
        run: |
          # Create dist directory if it doesn't exist
          mkdir -p dist
          
          # Get current version from existing file (or use default)
          if [ -f dist/bedrock-autoloader.php ]; then
            CURRENT_VERSION=$(grep -oP "Version:\s+\K[\d.]+" dist/bedrock-autoloader.php || echo "1.0.0")
          else
            CURRENT_VERSION="1.0.0"
          fi
          
          cat > dist/bedrock-autoloader.php << 'HEADER'
          <?php
          /**
           * Plugin Name:  Bedrock Autoloader MU
           * Plugin URI:   https://github.com/wp-spaghetti/bedrock-autoloader-mu
           * Description:  An autoloader that enables standard plugins to be required just like must-use plugins. The autoloaded plugins are included during mu-plugin loading. An asterisk (*) next to the name of the plugin designates the plugins that have been autoloaded. Self-contained version, auto-synced daily from roots/bedrock and roots/bedrock-autoloader.
           * Version:      VERSION_PLACEHOLDER
           * Author:       Frugan
           * Author URI:   https://github.com/wp-spaghetti
           * License:      MIT
           * License URI:  https://opensource.org/licenses/MIT
           * 
           * Based on original work by Roots (https://roots.io/)
           * 
           * This file is auto-generated by combining:
           * - https://github.com/roots/bedrock-autoloader/blob/master/src/Autoloader.php
           * - https://github.com/roots/bedrock/blob/master/web/app/mu-plugins/bedrock-autoloader.php
           * 
           * @package wp-spaghetti/bedrock-autoloader-mu
           */

          HEADER
          
          # Keep current version for now (will update later if changes detected)
          sed -i "s/VERSION_PLACEHOLDER/${CURRENT_VERSION}/g" dist/bedrock-autoloader.php
          
          # Extract only the class from Autoloader.php (remove <?php tag)
          sed '1d' Autoloader.php >> dist/bedrock-autoloader.php
          
          # Add spacing
          echo "" >> dist/bedrock-autoloader.php
          echo "" >> dist/bedrock-autoloader.php
          
          # Extract only the instantiation code from wrapper.php (skip namespace declaration)
          sed -n '/if.*is_blog_installed/,$p' wrapper.php >> dist/bedrock-autoloader.php
          
          # Cleanup temporary files
          rm Autoloader.php wrapper.php

      - name: Check for changes (ignore version line)
        id: check_changes
        run: |
          # Stage the new file
          git add dist/bedrock-autoloader.php
          
          # Check if there are changes ignoring the Version line
          if git diff --cached -I "Version:" --quiet dist/bedrock-autoloader.php; then
            echo "No code changes detected (only version would differ)"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Code changes detected"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Update version if changed
        if: steps.check_changes.outputs.changed == 'true'
        id: set_version
        run: |
          NEW_VERSION="1.0.$(date +'%Y%m%d')"
          echo "VERSION=${NEW_VERSION}" >> $GITHUB_OUTPUT
          
          # Update version in the file
          sed -i "s/Version:\s*[0-9.]\+/Version:      ${NEW_VERSION}/" dist/bedrock-autoloader.php
          
          echo "Updated version to ${NEW_VERSION}"

      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add dist/bedrock-autoloader.php
          git commit -m "chore: sync bedrock-autoloader.php from roots/bedrock and roots/bedrock-autoloader"
          git push

      - name: Create new tag if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          VERSION="${{ steps.set_version.outputs.VERSION }}"
          
          # Check if tag already exists
          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "Tag v${VERSION} already exists, skipping tag creation"
          else
            git tag -a "v${VERSION}" -m "Auto-sync version ${VERSION}"
            git push origin "v${VERSION}"
            echo "Created and pushed tag v${VERSION}"
          fi
